Запросы (`{{query}}`) — один из самых мощных инструментов в Logseq для анализа и организации вашей базы знаний. Они позволяют находить, фильтровать и динамически отображать блоки или страницы по заданным критериям. Вот подробное руководство по их использованию:

**1. Основной синтаксис:**
   *   Запросы пишутся внутри двойных фигурных скобок: `{{query }}`.
   *   Внутри них используется специальный язык запросов на основе **Datalog** (близкий к SQL по смыслу) или **простые фильтры**.

**2. Простые запросы (поиск по тексту, тегам, страницам):**
   *   **Поиск по тексту:**  
       `{{query "ваш поисковый запрос"}}`  
       *Пример:* `{{query "Python декоратор"}}` — найдет все блоки, содержащие эти слова.
   *   **Поиск по тегу (`#`):**  
       `{{query #тег}}`  
       *Пример:* `{{query #рецепт}}` — покажет все блоки, помеченные тегом `#рецепт`.
   *   **Поиск по странице (`[[]]`):**  
       `{{query [[Название страницы]]}}`  
       *Пример:* `{{query [[Упражнения]]}}` — покажет все ссылки *на* страницу "Упражнения" и все блоки *внутри* нее.

**3. Мощные запросы с использованием Datalog:**
   Для сложных условий нужен синтаксис Datalog. Базовая структура:

    ````
    {{query
      :query [:find (pull ?b [*]) 
              :where 
              ... ваши условия ... ]
      :inputs [ ... параметры ... ]
    }}
    ````

   **Ключевые элементы Datalog-запроса:**
   *   `:find (pull ?b [*])`: Возвращает полные данные найденных блоков (`?b`).
   *   `:where`: Здесь перечисляются условия отбора.
   *   `?b`: Переменная, представляющая блок (обычно используется именно она).
   *   **Условия (предикаты):**
        *   `[?b :block/content "текст"]`: Содержимое блока *точно равно* "текст".
        *   `[?b :block/content ?content]` + `[(clojure.string/includes? ?content "часть текста")]`: Содержимое блока *содержит* "часть текста".
        *   `[?b :block/page ?p]` + `[?p :block/name "Название страницы"]`: Блоки на странице с *точным* названием.
        *   `[?b :block/refs [:block/name "Название страницы"]]`: Блоки, *ссылающиеся на* страницу (аналогично простому `{{query [[page]]}}`).
        *   `[?b :block/refs [:block/name "тег"]]`: Блоки, помеченные *тегом* `#тег` (аналогично простому `{{query #тег}}`).
        *   `[?b :block/properties ?prop]` + `[(get ?prop "ключ") ?value]` + `[(= ?value "значение")]`: Блоки с определенным свойством (property).
        *   `[?b :block/marker ?marker]` + `[(= ?marker "TODO")]`: Найти все блоки с маркером `TODO`.
   *   **Логические операторы:**
        *   `AND` (и): Просто перечислите условия подряд.
        *   `OR` (или): Используйте `or-join` или `or` внутри условия.
        *   `NOT` (не): Используйте `(not ...)` вокруг условия.
   *   **Сортировка:**
        *   `:rules [[(sort ?b :block/created-at :desc)]]`: Сортировать по дате создания (по убыванию).

**4. Практические примеры запросов:**

    *   **Все блоки с тегом `#python` на странице `[[Советы]]`:**
        ````
        {{query
          :query [:find (pull ?b [*])
                  :where 
                  [?b :block/refs [:block/name "python"]] ; ссылка на тег #python
                  [?b :block/page ?p]
                  [?p :block/name "Советы"]] ; на странице "Советы"
        }}
        ````
    *   **Все рецепты (`#рецепт`), содержащие слово "курица" и помеченные как `#ужин`:**
        ````
        {{query
          :query [:find (pull ?b [*])
                  :where 
                  [?b :block/refs [:block/name "рецепт"]] ; тег #рецепт
                  [?b :block/refs [:block/name "ужин"]]   ; тег #ужин
                  [?b :block/content ?content]
                  [(clojure.string/includes? ?content "курица")]] ; содержит "курица"
        }}
        ````
    *   **Все упражнения (`#упражнение`) с типом "силовое" (используя свойство `type::`):**
        ````
        {{query
          :query [:find (pull ?b [*])
                  :where 
                  [?b :block/properties ?prop]           ; блок имеет свойства
                  [(get ?prop "type") ?type]             ; извлечь значение свойства "type"
                  [(= ?type "силовое")]                  ; значение равно "силовое"
                  [?b :block/refs [:block/name "упражнение"]]] ; и тег #упражнение
        }}
        ````
    *   **Последние 5 измененных блоков (сортировка по времени изменения):**
        ````
        {{query
          :query [:find (pull ?b [*])
                  :where [?b :block/updated-at ?t]
                  :rules [[(sort ?b :block/updated-at :desc)]]
          :inputs [:current-page]
          :result-transform (fn [result] (take 5 result)) ; взять только 5 последних
        }}
        ````

**5. Как использовать запросы:**

1.  **Создайте блок:** На любой странице создайте новый блок.
2.  **Введите запрос:** Начните писать `{{query` и Logseq предложит автодополнение. Выберите `query`.
3.  **Напишите условие:** Впишите ваш простой запрос (`"текст"`, `#тег`, `[[страница]]`) или полноценный Datalog-запрос внутри фигурных скобок.
4.  **Просмотр результатов:** Logseq **динамически отобразит** все блоки, соответствующие вашему запросу, прямо под блоком с запросом.
5.  **Обновление:** Результаты запроса обновляются автоматически при изменении базы знаний. Иногда может потребоваться ручное обновление страницы или переключение фокуса на блок с запросом.

**6. Полезные советы и подсказки:**

*   **Автодополнение:** Logseq хорошо подсказывает синтаксис Datalog внутри блока запроса. Используйте `Ctrl/Cmd + Space`.
*   **Изучение примеров:** В Logseq есть встроенные примеры! Начните писать `{{query`, выберите `query`, и Logseq вставит шаблон с несколькими примерами Datalog-запросов. Это лучший способ учиться.
*   **`:inputs :current-page`:** Добавление `:inputs [:current-page]` в запрос часто решает проблемы с поиском на текущей странице. Попробуйте, если запрос не возвращает ожидаемые результаты.
*   **`:result-transform`:** Позволяет программно обработать результат (например, `(take 10 result)` взять первые 10, `(reverse result)` развернуть порядок).
*   **Плагины:** Плагины вроде **Logseq Query Builder** (визуальный конструктор запросов) или **Logseq Charts** (визуализация данных из запросов) значительно упрощают работу.
*   **Документация:** Официальная документация по запросам — ваш друг: [https://docs.logseq.com/#/page/advanced%20queries](https://docs.logseq.com/#/page/advanced%20queries)
*   **Начните с простого:** Не пытайтесь сразу писать сложные Datalog-запросы. Начните с поиска по тегам или тексту. Постепенно усложняйте.
*   **Используйте для организации:** Создавайте на страницах-хабах запросы, которые автоматически собирают все связанные блоки (например, все рецепты с тегом `#суп` на странице `[[Рецепты супов]]`).

**7. Важные особенности:**

*   **Динамичность:** Результаты обновляются по мере изменения базы.
*   **Только чтение:** Результаты запроса — это *представление* существующих блоков. Изменение текста в результате запроса изменит исходный блок.
*   **Производительность:** Очень сложные запросы на больших базах могут тормозить. Старайтесь делать их конкретными.

**Начните экспериментировать!** Создайте блок с простым `{{query #важное}}` и посмотрите, что получится. Постепенно переходите к более сложным запросам — это мощный инструмент для раскрытия потенциала вашей базы знаний в Logseq.